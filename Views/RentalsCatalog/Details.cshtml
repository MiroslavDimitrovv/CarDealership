@model CarDealership.Models.Car

@{
    ViewData["Title"] = "Детайли";
}

<a asp-action="Index" class="btn btn-link mb-3">← Назад</a>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="card shadow-sm">
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-7">
                <img src="~/images/cars/@(Model.ImageFileName ?? "placeholder.jpg")"
                     class="img-fluid rounded shadow-sm"
                     style="max-height:420px; width:100%; object-fit:cover;"
                     alt="@Model.Brand @Model.Model" />
            </div>

            <div class="col-md-5">
                <h2>@Model.Brand @Model.Model (@Model.Year)</h2>

                <div class="h5 text-primary mb-3">
                    @((Model.RentPricePerDay ?? 0).ToString("0")) € / ден
                </div>

                <div class="text-muted mb-3">
                    @Model.Engine • @Model.HorsePower hp • @Model.Transmission
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.Description))
                {
                    <p class="small text-muted">@Model.Description</p>
                }

                <hr />
                <h5 class="mb-3">Наем на автомобила</h5>

                @if (!(User.Identity?.IsAuthenticated ?? false))
                {
                    <div class="alert alert-warning">
                        Трябва да си влязъл в профила си.
                    </div>
                }
                else
                {
                    <form id="rentForm" asp-action="Rent" method="post" class="row g-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="carId" value="@Model.Id" />
                        <input type="hidden" name="paymentMethod" id="paymentMethod" value="CashOnPickup" />

                        <div class="col-6">
                            <label class="form-label">От дата</label>
                            <input id="startDate" class="form-control" type="date"
                                   name="startDate"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                   required />
                        </div>

                        <div class="col-6">
                            <label class="form-label">До дата</label>
                            <input id="endDate" class="form-control" type="date"
                                   name="endDate"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                   required />
                        </div>

                        <div id="rentClientError" class="alert alert-danger d-none mb-0"></div>

                        <div class="col-12">
                            <button id="openRentConfirm" type="button" class="btn btn-primary w-100">
                                Потвърди наем
                            </button>
                        </div>
                    </form>

                    <!-- CONFIRM MODAL -->
                    <div class="modal fade" id="rentConfirmModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5>Потвърждение</h5>
                                    <button class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <ul class="small">
                                        <li>От: <strong id="confirmStart">-</strong></li>
                                        <li>До: <strong id="confirmEnd">-</strong></li>
                                    </ul>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                                    <button id="goToPayment" class="btn btn-primary">Напред към плащане</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PAYMENT MODAL -->
                    <div class="modal fade" id="paymentModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5>Плащане</h5>
                                    <button class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payRadio"
                                               value="CashOnPickup" checked>
                                        <label class="form-check-label">В брой при вземане</label>
                                    </div>

                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="payRadio"
                                               value="CardPrepay">
                                        <label class="form-check-label">Плащане с карта</label>
                                    </div>

                                    <!-- CARD TEST -->
                                    <div id="cardTestBox" class="border rounded p-3 mt-3 d-none">
                                        <div id="cardPayError" class="alert alert-danger d-none"></div>
                                        <div class="d-flex gap-2">
                                            <button id="btnCardSuccess" type="button" class="btn btn-success w-100">
                                                Успешно плащане
                                            </button>
                                            <button id="btnCardFail" type="button" class="btn btn-outline-danger w-100">
                                                Неуспешно плащане
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Назад</button>
                                    <button id="cashSubmitBtn" type="submit" form="rentForm" class="btn btn-primary">
                                        Потвърди (в брой)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        const startInput = document.getElementById("startDate");
                        const endInput = document.getElementById("endDate");
                        const errorBox = document.getElementById("rentClientError");

                        const confirmStart = document.getElementById("confirmStart");
                        const confirmEnd = document.getElementById("confirmEnd");

                        const hiddenPay = document.getElementById("paymentMethod");
                        const cardTestBox = document.getElementById("cardTestBox");
                        const cashBtn = document.getElementById("cashSubmitBtn");
                        const cardError = document.getElementById("cardPayError");

                        document.getElementById("openRentConfirm").onclick = () => {
                            if (!startInput.value || !endInput.value) {
                                errorBox.textContent = "Избери дати.";
                                errorBox.classList.remove("d-none");
                                return;
                            }
                            confirmStart.textContent = startInput.value;
                            confirmEnd.textContent = endInput.value;
                            new bootstrap.Modal(rentConfirmModal).show();
                        };

                        document.getElementById("goToPayment").onclick = () => {
                            bootstrap.Modal.getInstance(rentConfirmModal).hide();
                            new bootstrap.Modal(paymentModal).show();
                        };

                        document.querySelectorAll('input[name="payRadio"]').forEach(r => {
                            r.onchange = () => {
                                hiddenPay.value = r.value;
                                if (r.value === "CardPrepay") {
                                    cardTestBox.classList.remove("d-none");
                                    cashBtn.classList.add("d-none");
                                } else {
                                    cardTestBox.classList.add("d-none");
                                    cashBtn.classList.remove("d-none");
                                }
                            };
                        });

                        btnCardSuccess.onclick = () => {
                            hiddenPay.value = "CardPrepay";
                            rentForm.submit();
                        };

                        btnCardFail.onclick = () => {
                            cardError.textContent = "Плащането е неуспешно.";
                            cardError.classList.remove("d-none");
                        };
                    </script>
                }
            </div>
        </div>
    </div>
</div>
