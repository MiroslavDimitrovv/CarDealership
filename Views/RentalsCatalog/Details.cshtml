@model CarDealership.Models.Car
@{
    ViewData["Title"] = "Детайли";
}

<a asp-action="Index" class="btn btn-link mb-3">← Назад</a>

<div class="card shadow-sm">
    <div class="card-body">
        <h2 class="card-title">@Model.Brand @Model.Model (@Model.Year)</h2>
        <p class="lead"><strong>Цена за наем: @Model.RentPricePerDay евро/ден</strong></p>

        <dl class="row">
            <dt class="col-sm-3">Километраж</dt>
            <dd class="col-sm-9">@Model.Mileage</dd>

            <dt class="col-sm-3">Двигател</dt>
            <dd class="col-sm-9">@Model.Engine</dd>

            <dt class="col-sm-3">Конски сили</dt>
            <dd class="col-sm-9">@Model.HorsePower</dd>

            <dt class="col-sm-3">Гориво</dt>
            <dd class="col-sm-9">@Model.FuelType</dd>

            <dt class="col-sm-3">Скорости</dt>
            <dd class="col-sm-9">@Model.Transmission</dd>

            <dt class="col-sm-3">Описание</dt>
            <dd class="col-sm-9">@Model.Description</dd>
        </dl>
        <br />
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success mt-3">@TempData["Success"]</div>
        }

        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Наем на автомобила</h5>


                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger mt-3">@TempData["Error"]</div>
                }
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success mt-3">@TempData["Success"]</div>
                }



                @if (!(User.Identity?.IsAuthenticated ?? false))
                {
                    <div class="alert alert-warning mb-0">
                        За да наемеш автомобил, трябва да имаш профил.
                        <div class="mt-2 d-flex gap-2">
                            <a class="btn btn-primary"
                               asp-area="Identity" asp-page="/Account/Login"
                               asp-route-returnUrl="@Context.Request.Path">
                                Вход
                            </a>
                            <a class="btn btn-outline-primary"
                               asp-area="Identity" asp-page="/Account/Register"
                               asp-route-returnUrl="@Context.Request.Path">
                                Регистрация
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    @if (Model.Status != CarDealership.Models.Car.StatusType.Available)
                    {
                        <div class="alert alert-info mb-0">
                            Автомобилът в момента не е наличен за наем.
                        </div>
                    }
                    else
                    {
                        <form asp-action="Rent" method="post" class="row g-3">
                            @Html.AntiForgeryToken()

                            <input type="hidden" name="carId" value="@Model.Id" />

                            <div class="col-md-4">
                                <label class="form-label">От дата</label>
                                <input class="form-control" type="date" name="startDate"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">До дата</label>
                                <input class="form-control" type="date" name="endDate"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>

                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    Потвърди наем
                                </button>
                            </div>
                            @using System.Text.Json
                    @{
                                var bookedJson = JsonSerializer.Serialize(ViewBag.Booked);
                            }

                            <div class="mt-3">
                                <div class="fw-semibold mb-2">Заети периоди</div>

                                @if (((IEnumerable<dynamic>)ViewBag.Booked).Any())
                                {
                                    <ul class="small text-muted mb-0">
                                        @foreach (var b in (IEnumerable<dynamic>)ViewBag.Booked)
                                        {
                                            <li>@(((DateTime)b.start).ToString("dd.MM.yyyy")) – @(((DateTime)b.end).ToString("dd.MM.yyyy"))</li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="small text-muted">Няма заети периоди.</div>
                                }
                            </div>

                            <div id="rentClientError" class="alert alert-danger mt-3 d-none"></div>

                            <script>
                                const booked = @Html.Raw(bookedJson);

                                function parseDate(v) {
                                    const d = new Date(v + "T00:00:00");
                                    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                                }

                                function overlaps(aStart, aEnd, bStart, bEnd) {
                                    return aStart <= bEnd && aEnd >= bStart;
                                }

                                const startInput = document.querySelector('input[name="startDate"]');
                                const endInput = document.querySelector('input[name="endDate"]');
                                const errorBox = document.getElementById("rentClientError");
                                const submitBtn = document.querySelector('form[asp-action="Rent"] button[type="submit"]');

                                function validateClient() {
                                    errorBox.classList.add("d-none");
                                    submitBtn.disabled = false;

                                    if (!startInput.value || !endInput.value) return;

                                    const s = parseDate(startInput.value);
                                    const e = parseDate(endInput.value);

                                    if (e < s) {
                                        errorBox.textContent = "Крайната дата не може да е преди началната.";
                                        errorBox.classList.remove("d-none");
                                        submitBtn.disabled = true;
                                        return;
                                    }

                                    for (const b of booked) {
                                        const bs = new Date(b.start);
                                        const be = new Date(b.end);
                                        const bStart = new Date(bs.getFullYear(), bs.getMonth(), bs.getDate());
                                        const bEnd = new Date(be.getFullYear(), be.getMonth(), be.getDate());

                                        if (overlaps(s, e, bStart, bEnd)) {
                                            errorBox.textContent = "Автомобилът е зает за избрания период. Избери други дати.";
                                            errorBox.classList.remove("d-none");
                                            submitBtn.disabled = true;
                                            return;
                                        }
                                    }
                                }

                                startInput?.addEventListener("change", validateClient);
                                endInput?.addEventListener("change", validateClient);
                            </script>

                            <div class="col-12">
                                <div class="text-muted small">
                                    Цена: <strong>@(Model.RentPricePerDay?.ToString() ?? "-") € / ден</strong>
                                </div>
                            </div>
                        </form>
                    }
                }
            </div>
        </div>

        <br />

    </div>
</div>
