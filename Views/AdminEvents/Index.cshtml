@model CarDealership.Models.ViewModels.AdminEventsIndexVm

@{
    ViewData["Title"] = "Хронология";
    string fmt(DateTime d) => d.ToString("yyyy-MM-dd HH:mm");
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 m-0">Хронология</h1>

        <a class="btn btn-outline-secondary"
           asp-controller="AdminCars"
           asp-action="Index">
            ← Назад към Админ Панела
        </a>
    </div>

    <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-12 col-lg-4">
            <label class="form-label">Търсене</label>
            <input class="form-control" name="q" value="@Model.Q" placeholder="имейл, тип, IP, детайли..." />
        </div>

        <div class="col-12 col-lg-3">
            <label class="form-label">Тип</label>
            <select class="form-select" name="type">
                <option value="">(всички)</option>
                @foreach (var t in Model.Types)
                {
                    <option value="@t" selected="@(Model.Type == t)">@t</option>
                }
            </select>
        </div>

        <div class="col-6 col-lg-2">
            <label class="form-label">От (UTC)</label>
            <input class="form-control" type="datetime-local" name="fromUtc"
                   value="@(Model.FromUtc.HasValue? Model.FromUtc.Value.ToString("yyyy-MM-ddTHH:mm") : "")" />
        </div>

        <div class="col-6 col-lg-2">
            <label class="form-label">До (UTC)</label>
            <input class="form-control" type="datetime-local" name="toUtc"
                   value="@(Model.ToUtc.HasValue? Model.ToUtc.Value.ToString("yyyy-MM-ddTHH:mm") : "")" />
        </div>

        <div class="col-6 col-lg-1">
            <button class="btn btn-primary w-100" type="submit">Филтър</button>
        </div>

        <div class="col-6 col-lg-1">
            <a class="btn btn-outline-secondary w-100" asp-action="Index">Изчисти</a>
        </div>
    </form>

    <div class="text-muted small mb-2">
        Показани: <strong>@Model.Rows.Count</strong> (лимит 500)
    </div>

    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:160px">Кога (UTC)</th>
                    <th style="width:180px">Тип</th>
                    <th>Събитие</th>
                    <th style="width:240px">Кой</th>
                    <th style="width:240px">За кого</th>
                    <th style="width:120px">Refs</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in Model.Rows)
                {
                    <tr>
                        <td class="text-nowrap">@fmt(e.CreatedAtUtc)</td>
                        <td class="text-nowrap"><span class="badge bg-secondary">@e.Type</span></td>
                        <td>
                            <div class="fw-semibold">@e.Title</div>
                            @if (!string.IsNullOrWhiteSpace(e.Details))
                            {
                                <div class="text-muted small">@e.Details</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(e.Ip))
                            {
                                <div class="text-muted small">IP: @e.Ip</div>
                            }
                        </td>
                        <td>
                            <div class="fw-semibold">@((e.ActorEmail ?? "(system)"))</div>
                            <div class="text-muted small">@e.ActorUserId</div>
                        </td>
                        <td>
                            <div class="fw-semibold">@((e.TargetEmail ?? "(няма)"))</div>
                            <div class="text-muted small">@e.TargetUserId</div>
                        </td>
                        <td class="text-nowrap">
                            @if (e.CarId.HasValue)
                            {
                                <div>Car: @e.CarId</div>
                            }
                            @if (e.RentalId.HasValue)
                            {
                                <div>Rent: @e.RentalId</div>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!Model.Rows.Any())
    {
        <div class="alert alert-light border">Няма събития по зададените филтри.</div>
    }
</div>
